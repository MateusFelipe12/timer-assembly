;INCLUINDO REGISTRADORES DO PROCESSADOR
;DEFININDO CONFIGURAÇÕES
#INCLUDE <P16F628A.INC>
__CONFIG  _BODEN_ON & _CP_OFF & _PWRTE_ON & _WDT_OFF & _LVP_OFF & _MCLRE_ON & _XT_OSC


;DEFINIÇÃO DE COMANDOS DE ALTERAÇÃO DA PÁGINA DE MEMÓRIA
#DEFINE	BANK0	BCF STATUS,RP0	;SETA BANK 0 DE MEMÓRIA
#DEFINE	BANK1	BSF STATUS,RP0	;SETA BANK 1 DE MAMÓRIA

; DEFINIÇÃO DAS VARIAVEIS DO PROGRAMA
CBLOCK	0x20		

	CONTADOR	;BASE DE TEMPO DE UM SEGUNDO
	TEMPO1		;REGISTRADORES AUXILIARES DE TEMPO
	TEMPO2
	TIME		;REGISTRADOR DE TEMPO, MOSTRADO NA PORTB

ENDC			;FIM DO BLOCO DE MEMÓRIA		

; DEFINIÇÃO DE TODAS AS CONSTANTES UTILIZADAS PELO SISTEMA

MIN		EQU	.5 ;VEZES QUE VAI ITERAR O DELAY
F		EQU	B'00000001'

; DEFINIÇÃO DE TODOS OS PINOS QUE SERÃO UTILIZADOS COMO ENTRADA
#DEFINE	BT1	PORTA,1	;BOTÃO 1 - ATIVA O TIMER
			; 0 -> LIBERADO
			; 1 -> PRESSIONADO
			
ORG	0x00	;ENDEREÇO INICIAL DE PROCESSAMENTO
GOTO	INICIO


ORG	0x04		;ENDEREÇO INICIAL DA INTERRUPÇÃO
RETFIE			;RETORNA DA INTERRUPÇÃO

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                        ROTINA DE DELAY                          *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
			
; ESTA ROTINA AGUARDA TANTOS MILISEGUNDOS QUANTO O VALOR PASSADO
; POR W. POR EXEMPLO, SE W = .200, ELA AGUARDARÁ 200 MILISEGUNDOS.
;
; O DELAY PRINCIPAL DURA 1ms, POIS POSSUI 5 INSTRUÇÕES (5us) E É
; RODADO 200 VEZES (TEMPO1). PORTANTO 200 * 5us = 1ms.
; O DELAY PRINCIPAL É RODADO TANTAS VEZES QUANTO FOR O VALOR DE
; TEMPO2, O QUAL É INICIADO COM O VALOR PASSADO EM W.


DELAY
	MOVWF	TEMPO2		;INICIA TEMPO 2 COM O VALOR
				;PASSADO EM W
DL1	
	MOVLW	.200
	MOVWF	TEMPO1

DL2				;ESTE DELAY DURA 1ms (5*200) 1 SEGUNDO
	NOP
	NOP
	DECFSZ	TEMPO1,F	;DECREMENTA TEMPO1. ACABOU?
	GOTO	DL2		;NÃO, CONTINUA AGUARDANDO
				;SIM

	DECFSZ	TEMPO2,F	;DECREMENTA TEMPO2. ACABOU?
	GOTO	DL1		;NÃO, CONTINUA AGUARDANDO
				;SIM
	RETURN

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     INICIO DO PROGRAMA                          *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
	
INICIO
	BANK1			;ALTERA PARA O BANCO 1
	MOVLW	B'00000010'
	MOVWF	TRISA		;DEFINE RA1 E 2 COMO ENTRADA E DEMAIS
				;COMO SAÍDAS
	MOVLW	B'00000000'
	MOVWF	TRISB		;DEFINE TODO O PORTB COMO SAÍDA
	MOVLW	B'10000000'
	MOVWF	OPTION_REG	;PRESCALER 1:2 NO TMR0
				;PULL-UPS DESABILITADOS
				;AS DEMAIS CONFG. SÃO IRRELEVANTES
	MOVLW	B'00000000'
	MOVWF	INTCON		;TODAS AS INTERRUPÇÕES DESLIGADAS
	BANK0			;ALTERA PARA O BANCO 0
	MOVLW	B'00000111'
	MOVWF	CMCON		;DEFINE O MODO DE OPERAÇÃO DO COMPARADOR ANALÓGICO

;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     INICIALIZAÇÃO DAS VARIÁVEIS                 *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

	CLRF	PORTA		;LIMPA O PORTA
	MOVLW	MIN
	MOVWF	CONTADOR	;INICIA CONTADOR COM VALOR MIN.


;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
;*                     ROTINA PRINCIPAL                            *
;* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
MAIN
	MOVFW	B'00000000'	;INICIA O TIME EM 0
	MOVWF	TIME			
	
MAIN1
	MOVF	TIME,W		;APRESENTA O TIME NA PORTB
	MOVWF	PORTB		
	
	BTFSS	BT1		;BOTÃO 1 PRESSIONADO?
	GOTO	$-1		;NÃO
	GOTO	TIMER		;SIM, DEVE INICIAR O TIMER

TIMER
	MOVLW	MIN		;INICIA O CONTADOR EM MIN
	MOVWF	CONTADOR	;PASSA O MIN EM W TAMBEM
	CALL	DELAY		;CHAMA O DELAY DE 1S

	INCF	TIME,F		;INCREMENTA O TIME EM 1 BIT
	MOVF	TIME,W		;MOVE TIME PARA W
	MOVWF	PORTB		;APRESENTA O TIME EM PORTB
	BTFSS	BT1		;BOTÃO 2 CONTINUA PRESSIONADO?
	GOTO	MAIN		;NÃO, VOLTA AO INICIO
				;SIM, SEGUE A ROTINA DE DELAY
	GOTO	TIMER		;CONTINUA A ROTINA TIMER


	END			;OBRIGATÓRIO

